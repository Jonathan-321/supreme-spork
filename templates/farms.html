{% extends 'base.html' %}

{% block title %}AgriFinance - Farms{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Farm Management</h2>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#registerFarmModal">
        <i class="fas fa-plus me-1"></i> Register New Farm
    </button>
</div>

<!-- Farm Registration Modal -->
<div class="modal fade" id="registerFarmModal" tabindex="-1" aria-labelledby="registerFarmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registerFarmModalLabel">Register New Farm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="farmRegistrationForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="farmName" class="form-label">Farm Name</label>
                            <input type="text" class="form-control" id="farmName" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="farmArea" class="form-label">Farm Area (hectares)</label>
                            <input type="number" class="form-control" id="farmArea" name="area" step="0.1" min="0.1" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="farmLocation" class="form-label">Location</label>
                            <select class="form-select" id="farmLocation" name="region_id" required>
                                <option value="">Select region...</option>
                                <option value="1">Eastern Region, Ghana</option>
                                <option value="2">Ashanti Region, Ghana</option>
                                <option value="3">Western Region, Ghana</option>
                                <option value="4">Central Region, Ghana</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="soilType" class="form-label">Soil Type</label>
                            <select class="form-select" id="soilType" name="soil_type">
                                <option value="">Select soil type...</option>
                                <option value="Clay">Clay</option>
                                <option value="Sandy">Sandy</option>
                                <option value="Loamy">Loamy</option>
                                <option value="Silt">Silt</option>
                                <option value="Rocky">Rocky</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="mainCrop" class="form-label">Main Crop</label>
                            <select class="form-select" id="mainCrop" name="main_crop" required>
                                <option value="">Select main crop...</option>
                                <option value="Maize">Maize</option>
                                <option value="Cassava">Cassava</option>
                                <option value="Rice">Rice</option>
                                <option value="Cocoa">Cocoa</option>
                                <option value="Coffee">Coffee</option>
                                <option value="Sorghum">Sorghum</option>
                                <option value="Millet">Millet</option>
                                <option value="Tomatoes">Tomatoes</option>
                                <option value="Peppers">Peppers</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="secondaryCrops" class="form-label">Secondary Crops</label>
                            <input type="text" class="form-control" id="secondaryCrops" name="secondary_crops" placeholder="E.g., Beans, Peppers, Tomatoes">
                            <div class="form-text">Separate multiple crops with commas</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="irrigationSwitch" name="irrigation">
                                <label class="form-check-label" for="irrigationSwitch">Farm has irrigation system</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="farmPhoto" class="form-label">Farm Photo (optional)</label>
                            <input type="file" class="form-control" id="farmPhoto" name="photo">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="farmDescription" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="farmDescription" name="description" rows="3" placeholder="Any additional details about your farm..."></textarea>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i> Adding a farm will allow you to monitor climate conditions specific to your farm's location and receive personalized recommendations.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitFarmRegistration">Register Farm</button>
            </div>
        </div>
    </div>
</div>

<!-- Farm Registration Success Modal -->
<div class="modal fade" id="farmSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 class="mb-3">Farm Successfully Registered!</h4>
                <p>Your farm has been added to your account. You can now monitor climate conditions and apply for crop-specific loans.</p>
                <p class="small text-muted mb-4">Farm ID: <span id="newFarmId">F-2025-1234</span></p>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Farm Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3 mb-md-0">
        <div class="modern-card farm-stats-card">
            <h3 class="text-white mb-3">Total Farms</h3>
            <div class="d-flex justify-content-between align-items-center">
                <span class="fs-2 fw-bold">2</span>
                <i class="fas fa-tractor text-success fa-2x"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
        <div class="modern-card farm-stats-card">
            <h3 class="text-white mb-3">Total Area</h3>
            <div class="d-flex justify-content-between align-items-center">
                <span class="fs-2 fw-bold">9.0 ha</span>
                <i class="fas fa-ruler-combined text-info fa-2x"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
        <div class="modern-card farm-stats-card">
            <h3 class="text-white mb-3">Avg. NDVI</h3>
            <div class="d-flex justify-content-between align-items-center">
                <span class="fs-2 fw-bold">0.65</span>
                <i class="fas fa-seedling text-success fa-2x"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="modern-card farm-stats-card">
            <h3 class="text-white mb-3">Climate Risk</h3>
            <div class="d-flex justify-content-between align-items-center">
                <span class="fs-2 fw-bold text-warning">Medium</span>
                <i class="fas fa-cloud-sun-rain text-warning fa-2x"></i>
            </div>
        </div>
    </div>
</div>

<!-- Farms Section -->
<div class="section-card mb-5">
    <div class="section-header">
        <h3>Your Farms</h3>
        <div class="d-flex">
            <div class="dropdown me-2">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-filter me-1"></i> Filter
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                    <li><a class="dropdown-item" href="#">All Farms</a></li>
                    <li><a class="dropdown-item" href="#">By Crop Type</a></li>
                    <li><a class="dropdown-item" href="#">Irrigated Only</a></li>
                </ul>
            </div>
            <div class="input-group input-group-sm">
                <input type="text" class="form-control" placeholder="Search farms...">
                <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
            </div>
        </div>
    </div>
    <div class="section-content">
        <!-- Farm cards in a more visual format -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="farm-detailed-card">
                    <div class="farm-card-header">
                        <div class="farm-card-title">
                            <h4>Riverside Farm</h4>
                            <span class="area-badge">5.2 ha</span>
                        </div>
                        <div class="farm-card-actions">
                            <a href="#" class="action-button me-2" data-bs-toggle="tooltip" title="Edit Farm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="#" class="action-button" data-bs-toggle="tooltip" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                    <div class="farm-card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="farm-info-section">
                                    <h5 class="info-title">Farm Details</h5>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-leaf me-2"></i>Main Crop:</span>
                                        <span class="info-value">Maize</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-seedling me-2"></i>Secondary Crops:</span>
                                        <span class="info-value">Beans, Groundnuts</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-mountain me-2"></i>Soil Type:</span>
                                        <span class="info-value">Sandy Loam</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-tint me-2"></i>Irrigation:</span>
                                        <span class="info-value text-info">Yes</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="farm-info-section">
                                    <h5 class="info-title">Climate Data</h5>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-temperature-high me-2 text-danger"></i>Temperature:</span>
                                        <span class="info-value">24°C</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-cloud-rain me-2 text-primary"></i>Precipitation:</span>
                                        <span class="info-value">12mm</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-seedling me-2 text-success"></i>NDVI:</span>
                                        <span class="info-value">0.68</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Risk Level:</span>
                                        <span class="info-value text-warning">Medium</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="farm-actions mt-3">
                            <a href="#" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-chart-line me-1"></i> View Climate Data
                            </a>
                            <a href="#" class="btn btn-sm btn-outline-success ms-2">
                                <i class="fas fa-hand-holding-usd me-1"></i> New Loan Application
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="farm-detailed-card">
                    <div class="farm-card-header">
                        <div class="farm-card-title">
                            <h4>Hilltop Farm</h4>
                            <span class="area-badge">3.8 ha</span>
                        </div>
                        <div class="farm-card-actions">
                            <a href="#" class="action-button me-2" data-bs-toggle="tooltip" title="Edit Farm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="#" class="action-button" data-bs-toggle="tooltip" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                    <div class="farm-card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="farm-info-section">
                                    <h5 class="info-title">Farm Details</h5>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-leaf me-2"></i>Main Crop:</span>
                                        <span class="info-value">Cassava</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-seedling me-2"></i>Secondary Crops:</span>
                                        <span class="info-value">Sweet Potato</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-mountain me-2"></i>Soil Type:</span>
                                        <span class="info-value">Clay Loam</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-tint me-2"></i>Irrigation:</span>
                                        <span class="info-value text-muted">No</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="farm-info-section">
                                    <h5 class="info-title">Climate Data</h5>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-temperature-high me-2 text-danger"></i>Temperature:</span>
                                        <span class="info-value">24°C</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-cloud-rain me-2 text-primary"></i>Precipitation:</span>
                                        <span class="info-value">12mm</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-seedling me-2 text-success"></i>NDVI:</span>
                                        <span class="info-value">0.62</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Risk Level:</span>
                                        <span class="info-value text-warning">Medium</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="farm-actions mt-3">
                            <a href="#" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-chart-line me-1"></i> View Climate Data
                            </a>
                            <a href="#" class="btn btn-sm btn-outline-success ms-2">
                                <i class="fas fa-hand-holding-usd me-1"></i> New Loan Application
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Climate Risk Advisory Section -->
<div class="section-card">
    <div class="section-header">
        <h3>Climate Risk Advisory</h3>
        <div class="d-flex align-items-center">
            <select class="form-select form-select-sm me-2" id="farmSelector">
                <option value="all">All Farms</option>
                <option value="1">Riverside Farm</option>
                <option value="2">Hilltop Farm</option>
            </select>
            <button class="btn btn-sm btn-outline-info" id="refreshClimateData">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="section-content">
        <div class="climate-risk-alert risk-level-medium">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="risk-header">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="riskType">DROUGHT</span> Risk: <span id="riskLevel">Medium</span>
                    </div>
                    <div class="risk-details mt-2">
                        <p id="riskImpact">Potential yield reduction of 20-30% if drought conditions persist.</p>
                    </div>
                </div>
                <div class="risk-gauge">
                    <div class="risk-probability">
                        <svg width="80" height="80" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#2a2a2a" stroke-width="10" />
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#ffc107" stroke-width="10" 
                                stroke-dasharray="282.7" stroke-dashoffset="155.5" transform="rotate(-90 50 50)" />
                            <text x="50" y="55" text-anchor="middle" fill="#fff" font-size="20">45%</text>
                        </svg>
                    </div>
                    <div class="small text-center mt-1">Probability</div>
                </div>
            </div>
            <div class="mitigation-measures mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Recommended Actions:</strong>
                    <span class="badge bg-primary">AI Recommended</span>
                </div>
                <ul class="action-list mb-0" id="mitigationMeasuresList">
                    <li class="action-item">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>Implement irrigation where available</span>
                    </li>
                    <li class="action-item">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>Consider drought-resistant crop varieties</span>
                    </li>
                    <li class="action-item">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>Apply mulch to reduce soil evaporation</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Interactive Risk Timeline -->
        <div class="risk-timeline mt-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Risk Trend (6 Months)</h5>
                <div class="timeline-controls">
                    <button class="btn btn-sm btn-outline-secondary" id="viewHistorical">Historical</button>
                    <button class="btn btn-sm btn-outline-primary active" id="viewForecast">Forecast</button>
                </div>
            </div>
            <div class="timeline-chart-container">
                <canvas id="riskTimelineChart" height="120"></canvas>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-4 mb-4 mb-md-0">
                <div class="climate-data-card">
                    <div class="climate-icon temperature-icon">
                        <i class="fas fa-temperature-high"></i>
                    </div>
                    <h5>Temperature Trend</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="text-muted mb-0">Trending 2°C above average</p>
                        <span class="temp-value">24°C</span>
                    </div>
                    <div class="temp-chart mt-2">
                        <canvas id="temperatureChart" height="60"></canvas>
                    </div>
                    <div class="climate-trend mt-2">
                        <i class="fas fa-arrow-up text-danger me-1"></i> Rising
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4 mb-md-0">
                <div class="climate-data-card">
                    <div class="climate-icon precipitation-icon">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <h5>Precipitation Trend</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="text-muted mb-0">30% below normal</p>
                        <span class="precip-value">12mm</span>
                    </div>
                    <div class="precip-chart mt-2">
                        <canvas id="precipitationChart" height="60"></canvas>
                    </div>
                    <div class="climate-trend mt-2">
                        <i class="fas fa-arrow-down text-warning me-1"></i> Declining
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="climate-data-card">
                    <div class="climate-icon ndvi-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h5>NDVI Vegetation Health</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="text-muted mb-0">Moderate health</p>
                        <span class="ndvi-value">0.65</span>
                    </div>
                    <div class="ndvi-chart mt-2">
                        <canvas id="ndviChart" height="60"></canvas>
                    </div>
                    <div class="climate-trend mt-2">
                        <i class="fas fa-minus text-info me-1"></i> Stable
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Interactive Action Button -->
        <div class="text-center mt-4">
            <button class="btn btn-primary" id="getClimateReport">
                <i class="fas fa-file-alt me-2"></i> Generate Full Climate Assessment Report
            </button>
        </div>
    </div>
</div>

<!-- Climate Report Modal -->
<div class="modal fade" id="climateReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Climate Risk Assessment Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="report-loading text-center p-5" id="reportLoading">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Generating comprehensive climate assessment...</p>
                </div>
                
                <div class="report-content" id="reportContent" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>Climate Risk Analysis</h4>
                        <div class="report-meta">
                            <div>Report Date: April 27, 2025</div>
                            <div>Reference ID: CR-78942</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Medium Risk Alert:</strong> Current climate conditions indicate a medium risk level for the Eastern Region of Ghana.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Key Findings</h5>
                            <ul>
                                <li>Precipitation levels are 30% below seasonal average</li>
                                <li>Temperature is trending 2°C above normal</li>
                                <li>Moderate drought conditions expected to persist</li>
                                <li>Current NDVI readings indicate adequate but stressed vegetation health</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Projected Impact</h5>
                            <ul>
                                <li>20-30% potential reduction in crop yields if no action taken</li>
                                <li>Increased irrigation needs for optimal growth</li>
                                <li>Extended growing season due to higher temperatures</li>
                                <li>Possible increase in certain pest activities</li>
                            </ul>
                        </div>
                    </div>
                    
                    <h5>Recommended Mitigation Strategies</h5>
                    <div class="table-responsive mb-4">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Strategy</th>
                                    <th>Impact</th>
                                    <th>Cost</th>
                                    <th>Implementation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Implement irrigation</td>
                                    <td>High</td>
                                    <td>Medium-High</td>
                                    <td>Immediate</td>
                                </tr>
                                <tr>
                                    <td>Use drought-resistant varieties</td>
                                    <td>Medium-High</td>
                                    <td>Medium</td>
                                    <td>Next planting season</td>
                                </tr>
                                <tr>
                                    <td>Apply mulch for moisture retention</td>
                                    <td>Medium</td>
                                    <td>Low</td>
                                    <td>Immediate</td>
                                </tr>
                                <tr>
                                    <td>Adjust planting schedule</td>
                                    <td>Medium</td>
                                    <td>Low</td>
                                    <td>Next planting season</td>
                                </tr>
                                <tr>
                                    <td>Implement intercropping</td>
                                    <td>Medium-Low</td>
                                    <td>Low</td>
                                    <td>Next planting season</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h5>Financial Implications</h5>
                    <p>Based on current climate conditions and projected trends, we recommend:</p>
                    <ul>
                        <li>Consider climate risk insurance coverage</li>
                        <li>Apply for climate-adaptive financing options</li>
                        <li>Budget for additional irrigation costs of approximately $200-300 per hectare</li>
                        <li>Adjust revenue projections to account for potential yield decreases</li>
                    </ul>
                    
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        This assessment is based on current satellite data, weather station readings, and AI-powered climate modeling. Conditions may change and we recommend checking for updates regularly.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadReport" style="display: none;">
                    <i class="fas fa-download me-1"></i> Download Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Modern card styling for farm stats */
    .modern-card {
        background: linear-gradient(145deg, rgba(40, 44, 52, 0.7) 0%, rgba(25, 28, 36, 0.9) 100%);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 20px;
        height: 100%;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    
    /* Section Card Styling */
    .section-card {
        background-color: rgba(30, 33, 43, 0.6);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .section-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .section-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 500;
    }
    
    .section-content {
        padding: 20px;
    }
    
    /* Action buttons */
    .action-button {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--bs-light);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .action-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    /* Detailed Farm Card */
    .farm-detailed-card {
        background-color: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow: hidden;
        height: 100%;
    }
    
    .farm-card-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .farm-card-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .farm-card-title h4 {
        margin: 0;
        font-size: 18px;
        font-weight: 500;
    }
    
    .area-badge {
        background-color: rgba(76, 175, 80, 0.2);
        color: #66bb6a;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
    }
    
    .farm-card-body {
        padding: 20px;
    }
    
    .farm-info-section {
        margin-bottom: 15px;
    }
    
    .info-title {
        font-size: 16px;
        margin-bottom: 10px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .info-label {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .info-value {
        font-weight: 500;
    }
    
    /* Climate Risk Alert */
    .climate-risk-alert {
        padding: 15px;
        border-radius: 8px;
    }
    
    .risk-level-minimal {
        background-color: rgba(25, 135, 84, 0.1);
        border: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .risk-level-low {
        background-color: rgba(32, 201, 151, 0.1);
        border: 1px solid rgba(32, 201, 151, 0.2);
    }
    
    .risk-level-medium {
        background-color: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .risk-level-high {
        background-color: rgba(253, 126, 20, 0.1);
        border: 1px solid rgba(253, 126, 20, 0.2);
    }
    
    .risk-level-extreme {
        background-color: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    .risk-header {
        font-size: 16px;
        font-weight: 600;
    }
    
    .risk-details {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .risk-details p {
        margin-bottom: 10px;
    }
    
    .mitigation-measures {
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        margin-top: 10px;
    }
    
    /* Climate Data Cards */
    .climate-data-card {
        background-color: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 20px;
        height: 100%;
        text-align: center;
    }
    
    .climate-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin: 0 auto 15px;
    }
    
    .temperature-icon {
        background-color: rgba(244, 67, 54, 0.1);
        color: #ef5350;
    }
    
    .precipitation-icon {
        background-color: rgba(33, 150, 243, 0.1);
        color: #42a5f5;
    }
    
    .forecast-icon {
        background-color: rgba(156, 39, 176, 0.1);
        color: #ab47bc;
    }
    
    .climate-data-card h5 {
        font-size: 16px;
        margin-bottom: 10px;
    }
    
    .climate-data-card p {
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .climate-trend {
        font-weight: 500;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Climate Data Visualization
        initializeClimateCharts();
        
        // Farm Registration Form
        const farmRegistrationForm = document.getElementById('farmRegistrationForm');
        const submitFarmButton = document.getElementById('submitFarmRegistration');
        
        if (submitFarmButton && farmRegistrationForm) {
            submitFarmButton.addEventListener('click', function() {
                // Validate form
                if (validateFarmForm(farmRegistrationForm)) {
                    // Show success modal after simulating submission
                    submitFarmButton.disabled = true;
                    submitFarmButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registering...';
                    
                    // Simulate API call delay
                    setTimeout(() => {
                        // Generate a random farm ID
                        const farmId = 'F-2025-' + Math.floor(1000 + Math.random() * 9000);
                        document.getElementById('newFarmId').textContent = farmId;
                        
                        // Hide farm registration modal
                        const farmModal = bootstrap.Modal.getInstance(document.getElementById('registerFarmModal'));
                        farmModal.hide();
                        
                        // Show success modal
                        const successModal = new bootstrap.Modal(document.getElementById('farmSuccessModal'));
                        successModal.show();
                        
                        // Reset form and button
                        farmRegistrationForm.reset();
                        submitFarmButton.disabled = false;
                        submitFarmButton.innerHTML = 'Register Farm';
                    }, 1500);
                }
            });
        }
        
        // Farm area validation
        const farmAreaInput = document.getElementById('farmArea');
        if (farmAreaInput) {
            farmAreaInput.addEventListener('input', function() {
                // Add visual feedback
                if (this.value && parseFloat(this.value) > 0) {
                    this.classList.add('is-valid');
                    this.classList.remove('is-invalid');
                } else {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                }
            });
        }
        
        // Main crop and secondary crop relationship
        const mainCropSelect = document.getElementById('mainCrop');
        const secondaryCropsInput = document.getElementById('secondaryCrops');
        
        if (mainCropSelect && secondaryCropsInput) {
            mainCropSelect.addEventListener('change', function() {
                // Suggest complementary crops based on main crop selection
                const mainCrop = this.value;
                let suggestedCrops = '';
                
                switch(mainCrop) {
                    case 'Maize':
                        suggestedCrops = 'Beans, Groundnuts, Pumpkins';
                        break;
                    case 'Cassava':
                        suggestedCrops = 'Groundnuts, Maize, Vegetables';
                        break;
                    case 'Rice':
                        suggestedCrops = 'Azolla, Fish (in paddy)';
                        break;
                    case 'Cocoa':
                        suggestedCrops = 'Plantain, Banana, Cassava';
                        break;
                    case 'Tomatoes':
                        suggestedCrops = 'Onions, Peppers, Basil';
                        break;
                    default:
                        suggestedCrops = '';
                }
                
                if (suggestedCrops && !secondaryCropsInput.value) {
                    secondaryCropsInput.value = suggestedCrops;
                    secondaryCropsInput.setAttribute('placeholder', 'e.g., ' + suggestedCrops);
                }
            });
        }
        
        // Farm selector interactivity for climate data
        const farmSelector = document.getElementById('farmSelector');
        if (farmSelector) {
            farmSelector.addEventListener('change', function() {
                updateClimateData(this.value);
            });
        }
        
        // Refresh climate data
        const refreshButton = document.getElementById('refreshClimateData');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                
                // Simulate data refresh with delay
                setTimeout(() => {
                    updateClimateData(farmSelector.value);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh';
                }, 1500);
            });
        }
        
        // Risk timeline view toggle
        const historicalBtn = document.getElementById('viewHistorical');
        const forecastBtn = document.getElementById('viewForecast');
        
        if (historicalBtn && forecastBtn) {
            historicalBtn.addEventListener('click', function() {
                this.classList.add('active');
                forecastBtn.classList.remove('active');
                updateRiskTimeline('historical');
            });
            
            forecastBtn.addEventListener('click', function() {
                this.classList.add('active');
                historicalBtn.classList.remove('active');
                updateRiskTimeline('forecast');
            });
        }
        
        // Generate climate report
        const reportBtn = document.getElementById('getClimateReport');
        if (reportBtn) {
            reportBtn.addEventListener('click', function() {
                const reportModal = new bootstrap.Modal(document.getElementById('climateReportModal'));
                reportModal.show();
                
                // Show loading spinner
                document.getElementById('reportLoading').style.display = 'block';
                document.getElementById('reportContent').style.display = 'none';
                document.getElementById('downloadReport').style.display = 'none';
                
                // Simulate report generation
                setTimeout(() => {
                    document.getElementById('reportLoading').style.display = 'none';
                    document.getElementById('reportContent').style.display = 'block';
                    document.getElementById('downloadReport').style.display = 'inline-block';
                }, 2500);
            });
        }
        
        // Download report button
        const downloadBtn = document.getElementById('downloadReport');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                alert('Report download started. The PDF will be available in your downloads folder.');
            });
        }
        
        // Validate farm registration form
        function validateFarmForm(form) {
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            // Clear previous validation
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Check required fields
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.add('is-valid');
                }
            });
            
            // Special validation for numeric fields
            const farmArea = form.querySelector('#farmArea');
            if (farmArea && (!farmArea.value || parseFloat(farmArea.value) <= 0)) {
                farmArea.classList.add('is-invalid');
                isValid = false;
            }
            
            return isValid;
        }
        
        // Initialize climate charts
        function initializeClimateCharts() {
            // Risk Timeline Chart
            const riskCtx = document.getElementById('riskTimelineChart');
            if (riskCtx) {
                const riskLabels = ['Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Oct'];
                const riskData = [0.15, 0.25, 0.35, 0.40, 0.45, 0.45, 0.40, 0.30, 0.20, 0.15];
                
                const riskChart = new Chart(riskCtx, {
                    type: 'line',
                    data: {
                        labels: riskLabels,
                        datasets: [{
                            label: 'Risk Probability',
                            data: riskData,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: 1,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    callback: function(value) {
                                        return (value * 100) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Store chart reference for updates
                window.riskChart = riskChart;
            }
            
            // Temperature mini chart
            const tempCtx = document.getElementById('temperatureChart');
            if (tempCtx) {
                const tempChart = new Chart(tempCtx, {
                    type: 'line',
                    data: {
                        labels: ['', '', '', '', '', '', ''],
                        datasets: [{
                            data: [22, 23, 24, 24, 25, 26, 24],
                            borderColor: '#ef5350',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: false
                            }
                        }
                    }
                });
                
                window.tempChart = tempChart;
            }
            
            // Precipitation mini chart
            const precipCtx = document.getElementById('precipitationChart');
            if (precipCtx) {
                const precipChart = new Chart(precipCtx, {
                    type: 'bar',
                    data: {
                        labels: ['', '', '', '', '', '', ''],
                        datasets: [{
                            data: [18, 15, 12, 10, 8, 12, 9],
                            backgroundColor: 'rgba(33, 150, 243, 0.5)',
                            borderRadius: 4,
                            barThickness: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: false
                            }
                        }
                    }
                });
                
                window.precipChart = precipChart;
            }
            
            // NDVI mini chart
            const ndviCtx = document.getElementById('ndviChart');
            if (ndviCtx) {
                const ndviChart = new Chart(ndviCtx, {
                    type: 'line',
                    data: {
                        labels: ['', '', '', '', '', '', ''],
                        datasets: [{
                            data: [0.60, 0.63, 0.65, 0.64, 0.65, 0.68, 0.65],
                            borderColor: '#66bb6a',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: false
                            }
                        }
                    }
                });
                
                window.ndviChart = ndviChart;
            }
        }
        
        // Update climate data based on selected farm
        function updateClimateData(farmId) {
            console.log('Updating climate data for farm:', farmId);
            
            // Simulate data fetching and updating UI elements
            
            let riskType, riskLevel, riskImpact, probabilityText, riskColor, strokeDashArray;
            let temperatureData, precipitationData, ndviData;
            
            // Set data based on farm selection
            if (farmId === '1') {  // Riverside Farm (Maize)
                riskType = 'DROUGHT';
                riskLevel = 'Medium';
                riskImpact = 'Potential yield reduction of 20-30% if drought conditions persist.';
                probabilityText = '45%';
                riskColor = '#ffc107';  // warning color
                strokeDashArray = 282.7;  // Full circle circumference
                strokeDashOffset = 155.5;  // (1 - 0.45) * 282.7
                
                temperatureData = [22, 23, 24, 24, 25, 26, 24];
                precipitationData = [18, 15, 12, 10, 8, 12, 9];
                ndviData = [0.60, 0.63, 0.65, 0.64, 0.65, 0.68, 0.65];
            } 
            else if (farmId === '2') {  // Hilltop Farm (Cassava)
                riskType = 'DROUGHT';
                riskLevel = 'Low';
                riskImpact = 'Cassava is drought-tolerant. Expected yield reduction of 10-15% if conditions persist.';
                probabilityText = '30%';
                riskColor = '#20c997';  // info/teal color
                strokeDashArray = 282.7;
                strokeDashOffset = 197.9;  // (1 - 0.30) * 282.7
                
                temperatureData = [21, 22, 23, 22, 24, 25, 23];
                precipitationData = [20, 18, 15, 12, 10, 14, 12];
                ndviData = [0.65, 0.67, 0.68, 0.67, 0.66, 0.70, 0.68];
            }
            else {  // All farms or default
                riskType = 'DROUGHT';
                riskLevel = 'Medium';
                riskImpact = 'Potential yield reduction of 20-30% if drought conditions persist across the region.';
                probabilityText = '45%';
                riskColor = '#ffc107';
                strokeDashArray = 282.7;
                strokeDashOffset = 155.5;  // (1 - 0.45) * 282.7
                
                temperatureData = [22, 23, 24, 24, 25, 26, 24];
                precipitationData = [18, 15, 12, 10, 8, 12, 9];
                ndviData = [0.62, 0.64, 0.66, 0.65, 0.65, 0.68, 0.66];
            }
            
            // Update risk information
            document.getElementById('riskType').textContent = riskType;
            document.getElementById('riskLevel').textContent = riskLevel;
            document.getElementById('riskImpact').textContent = riskImpact;
            
            // Update risk gauge
            const gaugeCircle = document.querySelector('.risk-probability svg circle:nth-child(2)');
            const gaugeText = document.querySelector('.risk-probability svg text');
            
            if (gaugeCircle && gaugeText) {
                gaugeCircle.setAttribute('stroke', riskColor);
                gaugeCircle.setAttribute('stroke-dashoffset', strokeDashOffset);
                gaugeText.textContent = probabilityText;
            }
            
            // Update risk alert class
            const riskAlert = document.querySelector('.climate-risk-alert');
            if (riskAlert) {
                riskAlert.className = 'climate-risk-alert risk-level-' + riskLevel.toLowerCase();
            }
            
            // Update chart data
            if (window.tempChart) {
                window.tempChart.data.datasets[0].data = temperatureData;
                window.tempChart.update();
            }
            
            if (window.precipChart) {
                window.precipChart.data.datasets[0].data = precipitationData;
                window.precipChart.update();
            }
            
            if (window.ndviChart) {
                window.ndviChart.data.datasets[0].data = ndviData;
                window.ndviChart.update();
            }
            
            // Update displayed values
            const tempValue = document.querySelector('.temp-value');
            const precipValue = document.querySelector('.precip-value');
            const ndviValue = document.querySelector('.ndvi-value');
            
            if (tempValue) tempValue.textContent = temperatureData[temperatureData.length - 1] + '°C';
            if (precipValue) precipValue.textContent = precipitationData[precipitationData.length - 1] + 'mm';
            if (ndviValue) ndviValue.textContent = ndviData[ndviData.length - 1].toFixed(2);
        }
        
        // Update risk timeline based on view (historical or forecast)
        function updateRiskTimeline(view) {
            if (!window.riskChart) return;
            
            let labels, data;
            
            if (view === 'historical') {
                labels = ['Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'];
                data = [0.10, 0.15, 0.25, 0.35, 0.40, 0.45, 0.45];
            } else {
                labels = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
                data = [0.45, 0.40, 0.30, 0.20, 0.15, 0.10, 0.15];
            }
            
            window.riskChart.data.labels = labels;
            window.riskChart.data.datasets[0].data = data;
            window.riskChart.update();
        }
    });
</script>
{% endblock %}